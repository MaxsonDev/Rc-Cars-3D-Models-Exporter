# Rc Cars 3D Models Exporter
**Rc Cars 3D Models Exporter** - это скрипт, написанный на языке Python. Скрипт предназначен для экспорта 3D моделей из файлов компьютерной игры ***"Rc Cars"*** в программу **Blender**. В странах СНГ игра более известна под названием ***"Недетские гонки"***.

# Как запустить скрипт?
### Для запуска скрипта нам понадобиться 3 вещи:
1. Файл игры формата `.sb`. В файлах этого формата хранится информация о всех объектах игры.
2. 3D редактор **Blender 2.80** версии и _выше_.
3. Скрипт **rccars_3d_models_exporter.py**.

### Чтобы запустить скрипт надо:
1. Запустить программу **Blender**. После запуска желательно удалить лишние объекты(куб, свет, камера), чтобы не мешали.
2. Открыть окно **Scripting** и открыть скрипт.
3. Найти скрипт **rccars_3d_models_exporter.py** в той папке, в которую вы его сохранили, и открыть.
4. В тексте скрипта найти переменную **FILE_PATH** и прописать в ней путь к `.sb` файлу. Пример написания пути к файлу в Windows и Linux(мб кто-то бдует запускать в Linux. LOL):
```
# Windows
FILE_PATH = "C:\\my\\path\\to\\file.sb"
# Linux
FILE_PATH = "/my/path/to/file.sb"
```
5. Запустить скрипт и подождать.
6. Готово!
![beach_1.sb](/image/result_example_1.jpg)
# Как это работает?
> [!NOTE]
> Вся указанная ниже инфоромация строится на лично проведенном реверсинженеринге, анализе и изучении файлов. Как это должно конкретно работать известно только разработчикам.
> Я лишь делаю выводы из найденой информации и строю теории.

> [!NOTE]
> `^` - обозначает отображение чанков в `.sb` файле. Т.к. данные в `.sb` файле записаны _"зеркально"_, то, 
> если в `.sb` файле чанк записан как `^0092h`, то в оригинале это значение `9200h`. Как и HSEM - это MESH.
>
> `1111h и 0x1111` - h и 0x обозначают, что число записано в 16-й системе.

## Структура файла
Файл `.sb` является бинарным и имеет строгую побайтовую логику. Файл состоит из 2 блоков данных: - **заголовки файла и игровые объекты MOD**.
1. Блок **Заголовки файлов.**
Заголовки файлов инициализируют файл в игре. Состоят из сигнатуры(цифровой подписи `3801h(^0138h)`), текстовых заголовков, и инициализации MODs в файле. 
2. Блок **Игровые объекты MOD.**
**MOD** - это своего рода API игры. Таким API являются MESH, MODL, CAMR, SCRI, FOLD, SOND и т.д. Занимают **4 байта**. Все MOD инициализируются в заголовках, и даже те, котрые могут быть не использоваться в файле. MOD инициализируются чанком `9A00h(^009Ah)` в заголовках. Вызываются чанком `9200h(^0092h)`. Список всех MOD можно увидеть в заголовках файла. У каждого MOD есть свой набор чанков, которые относятся к нему. Условно можно считать MOD за _класс_, а чанки его _методами_.

Структура записи данных имеет определенный шаблон: 
```
Чанк[1] + Указатель на конец данных[2] + Данные[3]
```
1. **Чанк** - группа данных, состоящая из **2 байт**. Каждый чанк уникален и имеет свою задачу. Чанк дает команду программе(exe-файл игры), что надо делать с данными, которые чанк хранит, как их обрабатывать. Пример: `7411h(^1174h)` - говорит программе, что в чанке хранятся вершины 3D модели, и программа, благодаря чанку, знает что это за данные, как устроены, как их обработать.
2. **Указатель на конец данных** - группа данных, состоящая из **4 байт**. Хранит адрес, на котором данные чанка заканчиваются. Некоторые чанки хранят внутри себя другие чанки, поэтому в данных могут оказаться другие чанки.
3. **Данные** - группа данных, состоящая из **x байт**. Может занимать любую длину байт.

## Известные чанки
Описание некоторых чанков, которые используются в скрипте и о работе которых известно.
Обозначение:<br/>**Length** - длина данных в байтах, которые хранит чанк.<br/>**Type** - тип данных.
### Общие чанки
**3801h(^0138h)**  - сигнатура файла`.sb`. Записывается в первые 2 байта файла. Является цифровой подписью. _Length_: **4 байта**. _Type_: **int**. Во всех файлах имеет значение 0x00060000. Суть значения неизвестно.

**9200h(^0092h)**  - вызов MOD. _Length_: **4 байта**. _Type_: **int**. Но почему тип данных _int_, хотя MOD это текст? Технически, при вызове MODa, данные проверяются не как строка, к примеру, MESH, а как 16-ое число, получаемое из кодов, обозначающие эту строку в кодировке ASCII: `M(4D)E(45)S(53)H(48) == 0x4D455348.` Но проще конечно рассматривать как строку.

**9A00h(^009Ah)**  - инициализация MOD. _Length_: **4 байта**. _Type_: **int**. Причина того, что тип данных int такая же, как в чанке `9200h`.

**4803h(^0348h)** - хранит название объекта. _Length_: **длина строки + 1 нулевой байт**. _Type_: **string**.

### MESH чанки
Чанки используются только в MOD MESH.<br/><br/>
**7411h(^1174h)** - хранит данные о **всех** вершинах(vertex) 3D модели. Вершина - это 3 float координаты. По 1 float на каждую ось пространсвта. 1 float == 4 байта.<br/>_Length_: **3 * 4 байт**. _Type_: **float**. Структура чанка:<br/>
`^1174h[2 байта] + указатель на конец данных[4 байта] + количество вершин[4 байта] + координаты вершин[3*4 байта] * число вершин`

**7413h(^1374h)** - хранит данные о **всех** координатах UV развертки 3D модели. Одна координата состоит из 2 флоат. 1 float == 4 байта.<br/>_Length_: **2 * 4 байт**. _Type_: **float**. Структуру чанка:<br/>
`^1374h[2 байта] + указатель на конец данных[4 байта] + количесвто координат[4 байта] + координаты вершин[2*4 байта] * число координат`

**3419h(^1934h)** - хранит данные об **1** полигоне(face) 3D модели. Полигон состоит из 3 int вершин. 1 int == 4 байта.<br/>_Length_: **3 * 4 байт**. _Type_: **int**. Структура чанка:<br/>
`^1934h[2 байта] + указатель на конец данных[4 байта] + количесвто вершин[4 байта] + номера вершин[3*4 байта] * количесвто вершин(3)`
## Как читать данные?
Обратимся к скриншоту из hex-редактора HxD. Как понять какие данные здесь указаны? Как это читать?
За пример рассмотрим пример записи чанка `7411h(^1174h)`, который хранит данные о вершинах 3D модели **Cola** в файле `stone.sb`.
1. Зеленым помечен "открывающий чанк" `7411h(^1174h)`. Чанк записан по адресу `0x00000631` и занимает 2 байта.
2. Красным, после "открывающего чанка", идет указатель на адрес, где чанк заканчивается. Занимает 4 байта. В данном случае указатель говорит, что чанк заканчивается по адресу `0x00000863`. В этом можно убедиться, посмотрев на этот адрес. По этому же адресу начинается следующий чанк `7413h(^1374h)` и также после чанка указан адрес где он будет заканчиваться - `0x0000099D`.
3. Синим указана струтктура данных. У каждого чанка структура данных разная и не обо всех чанках все извечтно, что они делают, что из себя представляют. Но что известно о чанке `7411h(^1174h)`. Первые 4 байта говорят сколько вершин имеет 3D модель. В данном примере вершин `0x0000002E(16) == 46(10)`. Получается из 46 вершин состоит модель **Cola**. Далее идут координаты этих вершин. 1 координата - это 3 значения в 3D пространстве(XYZ). 3 значения занимают 12 байт(3 * 4 байт). Какие значения у первой координаты в примере:
<br/>    1) `0xBE000000(16) == -0.125`
<br/>    2) `0x00000000(16) == 0.0`
<br/>    3) `0x00000000(16) == 0.0`<br/>
Значение первой кординаты: `(-0.125, 0.0, 0.0)`<br/>
Посмотрим координаты следующей вершины:
<br/>    1) `0xBDDD2F1B(16) == -0.108`
<br/>    2) `0xBD810625(16) == -0.063`
<br/>    3) `0x00000000(16) == 0.0`<br/>
Значение второй кординаты: `(-0.108, -0.063, 0.0)`<br/>
Таким образом записаны все 46 вершин. Даные занимают: 4 + 46 * 3 * 4 = 556 байта.
<br/>Итого получаем такую структуру:<br/>
`7411h[2 байта] + 0x00000863[4 байта] + 0x0000002E[4 байта] + координаты вершин[3*4 байта] * 46`
<br/><br/>
![Example](/image/2025-02-12_181419.jpg)


